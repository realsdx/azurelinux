From ea25f2e6ffdef7f109f69fde773bebf3f9227ed5 Mon Sep 17 00:00:00 2001
From: Muhammad Falak R Wani <falakreyaz@gmail.com>
Date: Tue, 26 Mar 2024 10:20:52 +0530
Subject: [PATCH 2/2] CVE-2024-23652

Signed-off-by: Muhammad Falak R Wani <falakreyaz@gmail.com>
---
 vendor/github.com/moby/buildkit/executor/stubs.go | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/vendor/github.com/moby/buildkit/executor/stubs.go b/vendor/github.com/moby/buildkit/executor/stubs.go
index 22a8ac1..e60680e 100644
--- a/vendor/github.com/moby/buildkit/executor/stubs.go
+++ b/vendor/github.com/moby/buildkit/executor/stubs.go
@@ -4,6 +4,7 @@ import (
 	"errors"
 	"os"
 	"path/filepath"
+	"strings"
 	"syscall"
 
 	"github.com/containerd/continuity/fs"
@@ -51,6 +52,11 @@ func MountStubsCleaner(dir string, mounts []Mount, recursive bool) func() {
 
 	return func() {
 		for _, p := range paths {
+			p, err := fs.RootPath(dir, strings.TrimPrefix(p, dir))
+			if err != nil {
+				continue
+			}
+
 			st, err := os.Lstat(p)
 			if err != nil {
 				continue
@@ -58,6 +64,11 @@ func MountStubsCleaner(dir string, mounts []Mount, recursive bool) func() {
 			if st.IsDir() {
 				entries, err := os.ReadDir(p)
 				if err != nil {
+
+			parent := filepath.Dir(p)
+			if realPath, err := fs.RootPath(dir, strings.TrimPrefix(parent, dir)); err != nil || realPath != parent {
+				continue
+			}
 					continue
 				}
 				if len(entries) != 0 {
-- 
2.40.1

